@page "/Entrada/Create"
@page "/Entrada/Edit/{EntradaId:int}"

@using GestionDeEntradasInventario.Services
@using GestionDeEntradasInventario.Models
@inject EntradasService entradasService
@inject ProductosService productosService
@inject IJSRuntime JSRuntime
@inject NavigationManager navigationManager
@rendermode InteractiveServer

<PageTitle>@titulo</PageTitle>

<EditForm Model="Entrada" OnValidSubmit="Guardar">
    <DataAnnotationsValidator />
    <div class="container">
        <div class="card shadow-lg">
            <div class="card-header text-center">
                <h5 class="card-title">@titulo</h5>
            </div>

            <div class="card-body">
                @* --- Datos de Cabecera (Entrada) --- *@
                <div class="row">
                    <div class="col-md-2 mt-3">
                        <label class="form-label">ID</label>
                        <InputNumber class="form-control" @bind-Value="Entrada.EntradaId" readonly></InputNumber>
                    </div>

                    <div class="col-md-4 mt-3">
                        <label class="form-label">Fecha</label>
                        <InputDate class="form-control" @bind-Value="Entrada.Fecha"></InputDate>
                    </div>

                    <div class="col-md-6 mt-3">
                        <label class="form-label">Concepto</label>
                        <InputText class="form-control" @bind-Value="Entrada.Concepto" placeholder="Ej: Compra de inventario inicial"></InputText>
                        <ValidationMessage For="@(() => Entrada.Concepto)" />
                    </div>
                </div>

                @* --- Sección de Detalle (Agregar Productos) --- *@
                <div class="border border-success p-3 mt-4">
                    <h5>Detalle de la Entrada</h5>
                    <div class="row align-items-end mb-3">

                        @* Selección de Producto *@
                        <div class="col-md-5">
                            <label class="form-label">Producto</label>
                            <InputSelect @bind-Value="productoSeleccionadoId" class="form-select">
                                <option value="0" selected>-- Seleccione un Producto --</option>
                                @foreach (var prod in listaProductos)
                                {
                                    <option value="@prod.ProductoId">@prod.Descripcion (Costo: @prod.Costo.ToString("C2"))</option>
                                }
                            </InputSelect>
                        </div>

                        @* Cantidad *@
                        <div class="col-md-3">
                            <label class="form-label">Cantidad</label>
                            <InputNumber @bind-Value="cantidadDetalle" class="form-control" />
                        </div>

                        @* Botón Agregar *@
                        <div class="col-md-4">
                            <button @onclick="AgregarDetalle" type="button" class="btn btn-success">
                                <i class="bi bi-plus-circle"></i> Agregar
                            </button>
                        </div>
                    </div>

                    @* Tabla de Detalles Agregados *@
                    <div class="mt-3">
                        <table class="table table-bordered table-striped">
                            <thead class="table-light">
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Costo Unit.</th>
                                    <th>Importe</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var detalle in Entrada.EntradaDetalles)
                                {
                                    <tr>
                                        @* Buscamos la descripción en la lista local para mostrarla *@
                                        <td>@(listaProductos.FirstOrDefault(p => p.ProductoId == detalle.ProductoId)?.Descripcion ?? "Producto no encontrado")</td>

                                        <td>@detalle.Cantidad</td>
                                        <td>@detalle.Costo.ToString("C2")</td>
                                        <td>@((detalle.Cantidad * detalle.Costo).ToString("C2"))</td>

                                        <td>
                                            <button @onclick="() => RemoverDetalle(detalle)" type="button" class="btn btn-sm btn-danger">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                                @if (Entrada.EntradaDetalles.Count == 0)
                                {
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">No hay detalles agregados</td>
                                    </tr>
                                }
                            </tbody>
                        </table>

                        @* Resumen de Totales *@
                        <div class="d-flex justify-content-end">
                            <div class="me-4">
                                <strong>Artículos: </strong> @Entrada.EntradaDetalles.Sum(d => d.Cantidad)
                            </div>
                            <div>
                                <strong>Total: </strong> <span class="badge bg-success fs-6">@Entrada.Total.ToString("C2")</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-footer text-center">
                <a href="/Entrada/Index" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Volver
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-floppy"></i> Guardar
                </button>
                @if (esEdicion)
                {
                    <button type="button" @onclick="Eliminar" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Eliminar
                    </button>
                }
            </div>
        </div>
    </div>
</EditForm>

@code {
    [Parameter]
    public int EntradaId { get; set; }

    private Entrada Entrada { get; set; } = new Entrada();
    private List<Producto> listaProductos = new List<Producto>();

    private string titulo = "Crear Entrada";
    private bool esEdicion => EntradaId > 0;

    // Variables temporales para el input de detalle
    private int productoSeleccionadoId = 0;
    private int cantidadDetalle = 1;

    protected override async Task OnInitializedAsync()
    {
        // Cargar lista de productos para el ComboBox
        listaProductos = await productosService.Listar(p => true);
    }

    protected override async Task OnParametersSetAsync()
    {
        if (esEdicion)
        {
            titulo = "Editar Entrada";
            // Buscamos la entrada incluyendo sus detalles (el servicio ya hace el Include)
            var encontrado = await entradasService.Buscar(EntradaId);
            if (encontrado != null)
            {
                Entrada = encontrado;
            }
        }
    }

    private async Task AgregarDetalle()
    {
        // 1. Validaciones de entrada
        if (productoSeleccionadoId == 0)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Debe seleccionar un producto.");
            return;
        }
        if (cantidadDetalle <= 0)
        {
            await JSRuntime.InvokeVoidAsync("alert", "La cantidad debe ser mayor a 0.");
            return;
        }

        // 2. Buscar datos del producto (necesitamos el Costo original)
        var producto = listaProductos.FirstOrDefault(p => p.ProductoId == productoSeleccionadoId);
        if (producto == null) return;

        // 3. Crear el detalle
        var nuevoDetalle = new EntradaDetalle
        {
            ProductoId = producto.ProductoId,
            Cantidad = cantidadDetalle,
            Costo = producto.Costo // Costo viene del producto (ReadOnly)
        };

        // 4. Agregarlo a la lista de la entidad maestra
        Entrada.EntradaDetalles.Add(nuevoDetalle);

        // 5. Actualizar el Total Visual y limpiar campos
        CalcularTotal();
        productoSeleccionadoId = 0;
        cantidadDetalle = 1;
    }

    private void RemoverDetalle(EntradaDetalle detalle)
    {
        Entrada.EntradaDetalles.Remove(detalle);
        CalcularTotal();
    }

    private void CalcularTotal()
    {
        // Cálculo visual para el usuario
        Entrada.Total = Entrada.EntradaDetalles.Sum(d => d.Cantidad * d.Costo);
    }

    private async Task Guardar()
    {
        if (Entrada.EntradaDetalles.Count == 0)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Debe agregar al menos un producto al detalle.");
            return;
        }

        // El servicio se encarga de la lógica de inventario (Sumar al guardar)
        var guardo = await entradasService.Guardar(Entrada);

        if (guardo)
        {
            navigationManager.NavigateTo("/Entrada/Index");
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("alert", "Ocurrió un error al guardar la entrada.");
        }
    }

    private async Task Eliminar()
    {
        bool confirmado = await JSRuntime.InvokeAsync<bool>("confirm", "¿Está seguro? Eliminar la entrada REVERTIRÁ el inventario (restará existencias).");

        if (confirmado && esEdicion)
        {
            var eliminado = await entradasService.Eliminar(Entrada.EntradaId);
            if (eliminado)
            {
                navigationManager.NavigateTo("/Entrada/Index");
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "No se pudo eliminar la entrada.");
            }
        }
    }
}